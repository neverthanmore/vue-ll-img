!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).lazyLoad=t()}(this,function(){"use strict";function y(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function t(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}function b(e){return(b=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function n(e,t){return(n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function g(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function s(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(r=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{r||null==s.return||s.return()}finally{if(i)throw o}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var i=function(){function e(){y(this,e),this._events={},this._del=[]}return t(e,[{key:"$on",value:function(e,t){this._events[e]||(this._events[e]=[]),this.$has(e,t)||this._events[e].push(t)}},{key:"$once",value:function(e,t){var n=this;this.$on(e,function e(){n._del.push(e),t.apply(n,arguments)})}},{key:"$off",value:function(e,t){var n=this._events[e];if(n&&n.length){var r=n.indexOf(t);return-1<r?n.splice(r,1):void 0}}},{key:"$emit",value:function(t){for(var n=this,e=arguments.length,r=new Array(1<e?e-1:0),i=1;i<e;i++)r[i-1]=arguments[i];(this._events[t]||[]).forEach(function(e){return e.call.apply(e,[n].concat(r))}),this._del.forEach(function(e){return n.$off(t,e)}),this._del=[]}},{key:"$has",value:function(e,t){var n=this._events[e];return n&&n.includes(t)}}]),e}();var o=!!("IntersectionObserver"in window&&"IntersectionObserverEntry"in window&&window.IntersectionObserverEntry.prototype.hasOwnProperty("intersectionRatio"))&&(window.IntersectionObserverEntry.prototype.hasOwnProperty("isIntersecting")||Object.defineProperty(window.IntersectionObserverEntry.prototype,"isIntersecting",{get:function(){return 0<this.intersectionRatio}}),!0);var a=function(){if("undefined"!=typeof window){var e=!1;try{var t=Object.defineProperty({},"passive",{get:function(){e=!0}});window.addEventListener("test",null,t),window.removeEventListener("test",null,t)}catch(e){}return e}}(),u={on:function(e,t,n){var r=3<arguments.length&&void 0!==arguments[3]&&arguments[3];e.addEventListener(t,n,a?{passive:!0,capture:r}:r)},off:function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];e.removeEventListener.apply(e,[type].concat(n))}};function l(e,t){if(Array.isArray(e)&&e.length){var n=e.indexOf(t);-1<n&&e.splice(n,1)}}var d={},c=function(){function a(e){var t=e.imgStateSrc,n=e.preLoad,r=e.el,i=e.$parent,o=e.bindingType;y(this,a),this.img=t,this.preLoad=n,this.el=r,this.$parent=i,this.bindingType=o,this.performance={init:Date.now(),start:0,end:0},"dataset"in this.el?this.el.dataset.src=this.img.loaded:this.el.setAttribute("data-src",this.img.loaded),this.render("loading")}return t(a,[{key:"render",value:function(e){var t=this.el,n=this.bindingType,r=this.img[e];this.state=e,t.setAttribute("lazy",e),n?t.style[n]='url("'.concat(r,'")'):t.setAttribute("src",r)}},{key:"checkInView",value:function(){var e=this.el.getBoundingClientRect(),t=this.preLoad;return e.top<window.innerHeight*t&&0<e.bottom&&e.left<window.innerWidth*t&&0<e.right}},{key:"update",value:function(e){var t=this.img.loaded;this.img=e,t===this.img.loaded&&this.render("loading")}},{key:"load",value:function(){var t=this,e=this.img;if("loaded"===this.state||d[e.loaded])this.render("loaded");else{var n=new Image;n.src=e.loaded,this.performance.start=Date.now(),n.onload=function(){t.render("loaded"),d[e.loaded]=1,t.performance.end=Date.now()},n.onerror=function(e){console.error(e),t.render("error")}}}},{key:"destory",value:function(){this.img=null,this.preLoad=null,this.el=null,this.$parent=null}}]),a}();function f(e){return"".concat(v(e,"overflow")).concat(v(e,"overflow-x")).concat(f(e))}function v(e,t){return window.getComputedStyle?getComputedStyle(e,null).getPropertyValue(t):e.style[t]}var h="undefined"!=typeof window,w={rootMargin:"0px",threshold:0},m=["scroll","wheel","mousewheel","resize","animationend","transitionend","touchmove"],E="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",A=Object.prototype.toString,p=function(e){function p(e,t){var n,r,i,o,a,s,u,l=t.throttleWait,d=t.observerOptions,c=t.preLoad,f=t.error,v=t.loading,h=t.listenEventTypes;return y(this,p),r=this,(n=!(i=b(p).call(this))||"object"!=typeof i&&"function"!=typeof i?g(r):i).listenerQueue=[],n.scrollerElementQueue=[],n.vue=e,n.silent=e.config.silent,n._observer=null,n.options={preLoad:c||1.3,loading:v||E,error:f||E,observerOptions:d||w,listenEventTypes:h||m},n._events.loaded=[],n.lazyEventHandle=(o=n._lazyEventHandle.bind(g(n)),a=l||200,s=null,u=0,function(){if(!s){var e=Date.now()-u,t=this,n=arguments,r=function(){u=Date.now(),s=null,o.apply(t,n)};a<=e?r():s=setTimeout(r,a)}}),n.initObserverMode(),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&n(e,t)}(p,i),t(p,[{key:"initObserverMode",value:function(){o&&(this._observer=new IntersectionObserver(this._observerHandler.bind(this),this.options.observerOptions))}},{key:"_observerHandler",value:function(e){var n=this;e.forEach(function(t){if(t.isIntersecting){var e=n.listenerQueue.find(function(e){return e.el===t.target});if(e){if("loaded"===e.state)return n._observer.unobserve(e.el);e.load()}}})}},{key:"_lazyEventHandle",value:function(){var t=this,n=[];this.listenerQueue.forEach(function(e){return"loading"!==e.state?n.push(e):e.checkInView()?e.load():void 0}),n.forEach(function(e){return l(t.listenerQueue,e)})}},{key:"addListener",value:function(i,o,a){var s=this;if(this.elInQueue(i))this.updateListener(i,o,a);else{var e=this.valueFormatter(o.value),u=e.loaded,l=e.loading,d=e.error;this.vue.nextTick(function(){var e,t,n=o.arg;o.modifiers;n&&(e=a.context.$refs[n],t=document.getElementById(n),e=e?e.$el||e:t),e||(e=function(e){if("undefined"!=typeof window){if(e instanceof HTMLElement)return window;for(var t=e;t&&t!==document.body&&t!==document.documentElement&&t.parentNode;){if(/(overflow|auto)/.test(f(t)))return t;t=t.parentNode}return window}}(i));var r=new c({imgStateSrc:{loaded:u,loading:l,error:d},preLoad:s.options.preLoad,el:i,$parent:e,bindingType:Object.keys(o.modifiers)[0]});s.listenerQueue.push(r),s._observer&&s._observer.observe(i),h&&s.addToScrollerQueue(e===window?window:[window,e]),s.vue.nextTick(s.lazyEventHandle.bind(s))})}}},{key:"updateListener",value:function(e,t,n){var r=this,i=this.valueFormatter(t.value),o=i.loaded,a=i.loading,s=i.error,u=this.find(e);u?(u.update({loaded:o,loading:a,error:s}),this._observer&&(this._observer.unobserve(e),this._observer.observe(e)),this.vue.nextTick(function(){return r.lazyEventHandle()})):this.addListener(e,t,n)}},{key:"removeListener",value:function(e){if(e){this._observer&&this._observer.unobserve(e);var t=this.find(e);t&&(this._removeListenerTarget(t.$parent),this._removeListenerTarget(window),l(this.listenerQueue,t)&&t.destroy())}}},{key:"_removeListenerTarget",value:function(n){var r=this;this.scrollerElementQueue.forEach(function(e,t){e.el===n&&(e.childCount--,e.childCount||(r.bindLazyEvent(e.el,!1),r.scrollerElementQueue.splice(t,1),e=null))})}},{key:"addToScrollerQueue",value:function(e){var n=this;e&&(Array.isArray(e)?e:[e]).forEach(function(e){var t=n.findTarget(e);t?t.childCount++:(n.scrollerElementQueue.push({el:e,childCount:1}),!n._observer&&n.bindLazyEvent(e))})}},{key:"bindLazyEvent",value:function(t){var n=this,r=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];this.options.listenEventTypes.forEach(function(e){return u[r?"on":"off"](t,e,n.lazyEventHandle)})}},{key:"find",value:function(t){return this.listenerQueue.find(function(e){return e.el===t})}},{key:"elInQueue",value:function(t){return this.listenerQueue.some(function(e){return e.el===t})}},{key:"findTarget",value:function(t){return this.scrollerElementQueue.find(function(e){return e.el===t})}},{key:"valueFormatter",value:function(e){var t={loaded:"",loading:"",error:""},n=this.options,r=n.loading,i=n.error;return"[object Object]"===A.call(e)?function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];!(t.some(function(e){return"[object Object]"!==Object.prototype.toString.call(e)})||t.length<2)&&t.reduce(function(e,t){for(var n=Object.entries(t),r=0;r<n.length;r++){var i=s(n[r],2),o=i[0],a=i[1];a&&e.hasOwnProperty(o)&&(e[o]=a)}return e})}(t,{loading:r,error:i},e):Object.assign(t,{loading:r,error:i,loaded:e}),t}}]),p}();return{install:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if("2"==e.version.slice(0,1)||e.config.silent){var n=new p(e,t);e.prototype.$lazyLoad=n,e.directive("lazy-img",{bind:n.addListener.bind(n),update:n.updateListener.bind(n),componentUpdated:n.lazyEventHandle.bind(n),unbind:n.removeListener.bind(n)})}else console.error("【vue-lazyLoad】The plugin only support Vue2.x, please change your vuejs version!")}}});
